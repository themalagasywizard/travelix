# TravelJournal Progress Tracker

Last updated: 2026-02-24 18:10 Europe/Paris

## Phase 0 — Repo & foundations
- [ ] Create Xcode project
- [x] Set up modules / folders
- [x] Add dependencies scaffold (Swift Package with GRDB)

## Phase 1 — Data layer
- [x] Define initial domain entities (Place, Visit, Trip, Spot, Media, Tag)
- [x] Implement initial DB migration schema (v1 tables + indices)
- [x] Repository CRUD (implemented Place/Visit/Trip/Spot/Media repositories with CRUD unit tests; execution pending on Swift/Xcode-capable runner)
- [x] Seed demo data (implemented `DemoDataSeeder` with deterministic counts and added developer UI action `Load Demo Data`; runtime/UI verification pending on Xcode)

## Phase 2 — Globe MVP
- [~] Lat/Lon → 3D conversion utility (implemented `GlobeCoordinateConverter` + sanity unit tests; test execution pending on Swift/Xcode-capable runner)
- [~] SceneKit globe view wrapper (implemented `GlobeSceneView` with sphere, texture hook, camera, and lighting setup; runtime validation pending on iOS/macOS SceneKit environment)
- [~] Camera + gestures (added pan rotate, pinch zoom, inertial deceleration, and new double-tap interactions in `GlobeSceneView.Coordinator`—double-tap on a pin now focuses/zooms camera to that coordinate and triggers selection callback, while background double-tap performs step zoom-in; runtime tuning/verification pending on Xcode runner)
- [~] Render pins (added `GlobePin` model + pin container rendering pipeline in `GlobeSceneView`, with lat/lon placement via `GlobeCoordinateConverter`; visual/runtime validation pending on SceneKit runner)
- [~] Pin hit-testing (implemented tap hit-test on SceneKit nodes with `onPinSelected` callback and selected-pin highlight state in `GlobeSceneView`; runtime validation pending on Xcode runner)
- [~] Performance benchmark (added CPU-side benchmark utility `GlobePinRenderBenchmark` for 200-pin generation path + benchmark tests; Instruments/SceneKit FPS capture still pending on macOS/Xcode)

## Phase 3 — Core UI flows
- [~] Home = GlobeView + top search bar + filters (implemented `HomeView` + `HomeViewModel` with search field, filter chips, globe embedding, and pin selection state; runtime UI validation pending on Xcode)
- [~] Place Story screen (wired `HomeViewModel` to build repository-backed `PlaceStoryViewModel` data when pin↔place mapping and repositories are injected, with placeholder fallback retained for non-wired contexts; added repository-backed coverage in `HomeViewModelTests`; runtime UI validation pending on Xcode)
- [~] Visit Detail screen (wired Place Story visit-row selection to present `VisitDetailView` sheet via `selectedVisitDetailViewModel`; completed repository-backed detail hydration for notes/photo counts/spots/recommendations via `HomeViewModel` + `PlaceStoryVisitRow`, and expanded `PlaceStoryViewModelTests`/`HomeViewModelTests` coverage; runtime UI validation pending on Xcode)
- [~] Trips screen (implemented `TripsListViewModel` + `TripsListView` for repository-backed trip listing with date-range/visit-count summaries and friendly error banner handling; added `TripsListViewModelTests` for success/error states; now wired Home bottom bar with a Trips button that opens `TripsListView` in a sheet via repository-backed `HomeViewModel.makeTripsListViewModel()`, including unavailable-repository banner fallback and new `HomeViewModelTests` coverage; runtime navigation polish + visual validation pending on Xcode)
- [~] Deep link routing (implemented core `AppDeepLink` parser for `place://`, `visit://`, `trip://` plus `traveljournal://...` path routes; wired `HomeViewModel.handleDeepLink(_:)` to select place pins, apply trip filters, and queue visit deep links; this run added app-surface `onOpenURL` handling in `HomeView`, repository-backed visit deep-link hydration via new `VisitRepository.fetchVisit(id:)` + `HomeViewModel.consumePendingVisitDeepLinkDetailViewModel()`, and deep-linked Visit Detail sheet presentation with expanded `HomeViewModelTests`/`RepositoryCRUDTests`; runtime validation on manual Xcode integration remains pending)

## Phase 4 — Create/Edit content
- [~] Add Visit flow (modal) (implemented `AddVisitFlowView` + `AddVisitFlowViewModel` with 3-step flow: Location → Dates → Content, plus `saveVisit()` persistence wiring to `PlaceRepository`/`VisitRepository` with input validation and error states; updated save CTA to persist on final step, standardized validation/persistence failures through `ErrorPresentationMapper` banner models, and expanded `AddVisitFlowViewModelTests` for persistence + banner mapping coverage; now wired Home floating “+” CTA to present Add Visit flow, inject repository-backed flow model, and register successful saves back into `HomeViewModel` so the new place pin/metadata appears on the globe immediately with auto-selection; added “Use current location” step-1 UI action and `AddVisitCurrentLocationProviding` integration so resolved city/country/coordinates hydrate draft + persisted `Place` lat/lon metadata, with new async view-model tests for success/failure banner handling and resolved-coordinate persistence; runtime end-to-end verification pending on Xcode)
- [~] Edit Visit (implemented `EditVisitView` + `EditVisitViewModel` edit form and date-range validation with tests; date-range failures now emit shared `ErrorPresentationMapper` banner content via `dateValidationBanner`; wired repository-backed save via new `EditVisitViewModel(visit:locationName:repository:)` + `saveChanges()` flow, updated `EditVisitView` Save action to persist before dismiss, and expanded `EditVisitViewModelTests` to cover successful persistence plus mapped database-failure banners; runtime relaunch verification on Xcode runner still pending)
- [~] Spots CRUD (implemented repository-backed `VisitSpotsEditorViewModel` add/update/delete/load operations and unit tests with in-memory repository; wired Visit Detail to present a new `VisitSpotsEditorSheetView` via “Manage Spots” action and refresh displayed spots from repository-backed editor state; runtime UI verification pending on Xcode)
- [~] Tags (implemented `GRDBTagRepository` create/assign/remove/fetch operations, place IDs by tag query for deterministic globe filtering, and tests in `TagRepositoryTests` + `HomeViewModelTests`; runtime verification on Xcode runner and local Swift test execution still pending)

## Phase 5 — Media pipeline
- [~] PhotosPicker import (extended Add Visit persistence path so `AddVisitFlowViewModel` now accepts selected `MediaImportPayload` items and imports them via `MediaRepository` during `saveVisit()`, with new `AddVisitFlowViewModelTests` coverage for successful media import and media-import failure banner mapping; now wired `AddVisitFlowView` content step to `PhotosPicker` (when PhotosUI is available) and map selected assets into `MediaImportPayload` identifiers while keeping selected-count feedback visible; also fixed `HomeViewModel.makeAddVisitFlowViewModel` to forward `mediaRepository` and added `HomeViewModelTests` coverage for end-to-end media forwarding through save flow; runtime picker verification pending on Xcode runner)
- [~] Thumbnail generator + cache (implemented `DefaultThumbnailCache` with in-memory `NSCache` + on-disk cache file persistence keyed by media ID and pixel size; added `ThumbnailCacheStats` disk-usage introspection (`entryCount` + `totalBytes`) and expanded `ThumbnailCacheTests` for stats reporting after write/clear flows; wired `DeveloperToolsViewModel`/`DeveloperToolsView` with cache summary + “Clear Thumbnail Cache” action and added `DeveloperToolsViewModelTests` coverage for cache summary/clear behavior; image decode/generation pipeline integration + runtime verification pending on Xcode runner)
- [~] Offline validation (implemented `OfflineVisitValidator` producing `OfflineVisitValidationReport` by checking required thumbnail sizes per media item against `ThumbnailCache`; added `OfflineVisitValidatorTests` covering missing-thumbnail detection and all-cached success paths; airplane-mode UI/runtime validation still pending on Xcode runner)

## Phase 6 — Search & filters
- [~] Search index (extended `GRDBSearchRepository` SQL LIKE-based global search to also index trips (`SearchResultKind.trip`) alongside places/visits/spots/tags with deterministic priority ordering and limit; expanded `SearchRepositoryTests` to verify trip discoverability and retained deterministic limit behavior; additionally wired `HomeViewModel` search-query updates to repository-backed `searchResults` with selection handling (`handleSearchResultSelected`) and added an in-Home search results card UI in `HomeView` with kind icons and tap-to-focus behavior for mapped place hits; this run extended search-result selection behavior so trip/tag results now directly activate corresponding Home filters (`selectTrip` / `selectTag`) and clear the search result card after applying the filter; expanded `HomeViewModelTests` for repository-populated results, place-result focus mapping, trip/tag filter activation from search hits, and repository-failure banner mapping; runtime UI validation and Swift test execution on a Swift/Xcode runner still pending)
- [~] Filter chips (extended `HomeViewModel` filter state with explicit year/trip/tag selections and deterministic intersection logic across active chips; disabling a chip now clears its associated selection and recomputes visible pins; enabling an unconfigured chip now seeds deterministic default selections from sorted year/trip/tag option sets; wired `HomeView` chips to surface active selection labels; expanded Home search semantics so query matching now checks pin identifier plus optional place metadata title/subtitle (`PlaceSearchMetadata`) and pin list labels now prefer metadata titles for better accessibility/search consistency; expanded `HomeViewModelTests` for default-selection seeding, chip-title rendering, metadata-backed search matching, and pin-list title mapping; runtime UI wiring verification pending on Xcode runner)

## Phase 7 — Premium polish
- [~] Design system tokens (expanded `DesignTokens.swift` with typography and shadow token families in addition to spacing/radius; added `DesignTokensTests` for token scale/hierarchy/subtle-shadow constraints; Swift test execution and runtime visual verification pending on Xcode runner)
- [~] Haptics (added `HapticsClient` with injectable `HapticsEngine` and default UIKit-backed implementation using `UISelectionFeedbackGenerator`/`UINotificationFeedbackGenerator`, plus non-UIKit no-op fallback; now wired selection haptics into `HomeViewModel.handlePinSelected`, success/warning/error haptics into `AddVisitFlowViewModel` save + current-location failure paths, and success/warning/error haptics into `EditVisitViewModel.saveChanges`; expanded `HomeViewModelTests`, `AddVisitFlowViewModelTests`, and `EditVisitViewModelTests` with recording-engine assertions for emitted events; runtime tactile verification pending on iOS device/simulator via Xcode)
- [~] Motion (added `TJMotion` tokens with bounded durations and explicit curve presets via `MotionTokens.swift`, including globe-focus-specific spring timing; added `MotionTokensTests` covering duration bounds, ordering hierarchy, and curve selection; runtime animation tuning/verification pending on Xcode runner)
- [~] Accessibility pass (added centralized accessibility tokens in `TJAccessibility` and applied identifiers/labels to key Home and Visit Detail UI elements: search field, filter chips, selected-place badge, visit detail sections/header, plus a new Home “Pins List” VoiceOver fallback sheet for selecting visible pins without globe hit-testing; added `AccessibilityTokensTests` for token stability/label semantics and extended `HomeViewModelTests` coverage for deterministic/sorted pin list items filtered by search; this run added explicit accessibility identifiers + labels for Home bottom action buttons (Settings/Trips/Add Visit) and search-result rows, expanded `AccessibilityTokensTests` to lock those tokens/labels, and further extended accessibility coverage to Trips + Settings surfaces with new identifiers/labels (`trips.list`, `trips.row.*`, `trips.error.banner`, `settings.sync.*`) wired into `TripsListView`/`SettingsView`; VoiceOver/dynamic-type runtime validation still pending on Xcode runner)

## Phase 8 — Hardening
- [~] Error handling (added `TJAppError` + `ErrorPresentationMapper` to produce user-facing non-crashing banner models for database/media/input/unknown failures; wired `VisitSpotsEditorViewModel` failure paths to emit mapped `errorBanner` values alongside error text, then extended the same banner mapping to `AddVisitFlowViewModel`, `EditVisitViewModel`, and now `HomeViewModel` repository-hydration failures (with dismissible Home banner UI + new tests); this run extended mapped-banner handling into Developer + Settings sync surfaces via new `DeveloperToolsViewModel.errorBanner` and `SettingsViewModel.syncErrorBanner` states, surfaced those banners in `DeveloperToolsView`/`SettingsView`, and expanded `DeveloperToolsViewModelTests` + `SettingsViewModelTests` assertions for success/failure/invalid-input banner semantics; broader runtime banner presentation/validation across all UI flows still pending on Xcode runner)
- [~] Migrations + version bump (added `v2_add_visits_mood` migration in `DatabaseManager.makeMigrator()` introducing a dummy `visits.mood` column with default `""`; expanded `MigrationsTests` to assert latest schema column presence and to simulate v1→v2 upgrade path via migration table priming; Swift test execution still blocked in this environment)
- [~] Performance final (added `DatabasePerformanceBenchmark` with deterministic measurements for DB cold start and visit-read path over seeded rows; introduced `PerformanceBudgetEvaluator` (median + p95 budget gating) and expanded `DatabasePerformanceBenchmarkTests` with configurable p95 performance budgets (`TJ_DB_COLD_START_BUDGET_MS`, `TJ_DB_VISIT_READ_BUDGET_MS`), plus new `PerformanceBudgetEvaluatorTests`; Instruments traces for cold start + globe interaction still pending on macOS/Xcode, and benchmark execution remains pending on a Swift-capable runner in this container)

## Optional Phase 9 — iCloud sync
- [~] Feature flag (implemented `SyncFeatureFlagProviding` + `UserDefaultsSyncFeatureFlagStore` with deterministic default-off behavior and persistence toggling coverage in `SyncFeatureFlagsTests`; now added `SettingsViewModel` + `SettingsView` iCloud sync toggle wiring and integrated Home gear-button sheet presentation, with new `SettingsViewModelTests` covering initialization, persistence, and unchanged-toggle no-op behavior; this run added `SyncExecutionCoordinator` so sync run-loop execution is explicitly gated by the feature flag (disabled => no sync run, enabled => runs once and returns `SyncRunReport`) with focused async coverage in `SyncExecutionCoordinatorTests`; this run also extended Settings sync controls with an optional `runSyncNowAction` path (`SettingsViewModel.runSyncNow`) plus UI “Sync Now”/status affordances and expanded tests for action unavailable/disabled/success/failure states; this run added persistent last-successful-sync tracking via new `UserDefaultsSyncRunStatusStore`, surfaced “Last successful sync …” status in `SettingsViewModel`/`SettingsView`, and expanded `SettingsViewModelTests` + new `SyncRunStatusStoreTests` coverage for persistence/clear semantics and successful-run timestamp saves; runtime verification pending on Xcode)
- [~] CloudKit schema + sync engine (added sync-domain scaffolding with `SyncRecordEnvelope`, `SyncBatch`, and `CloudSyncEngine` protocol plus default `NoopCloudSyncEngine` factory implementation and baseline async coverage in `CloudSyncEngineTests`; now added deterministic sync merge utility `SyncBatchMerging.mergeLastWriteWins` (identity-based merge with remote-wins tie-breaker) and persisted pull-cursor store `UserDefaultsSyncCursorStore`, plus new `SyncOrchestrator` run-loop wiring for pending push → pull-since-cursor → local apply + cursor advancement with focused coverage in `SyncOrchestratorTests`; added `InMemoryCloudSyncStorage`/`InMemoryCloudSyncEngine` shared-transport scaffolding with cursor-aware pull semantics and deterministic last-write-wins/tie-break behavior, plus replication coverage in `CloudSyncEngineTests` to simulate multi-peer sync without CloudKit; this run extended sync envelopes with `isDeleted` tombstone support and deterministic equal-timestamp merge preference for tombstones, with new `CloudSyncEngineTests` coverage so delete-vs-update conflicts remain convergent across peers; now added `CloudKitSyncSchema` + `CloudKitSyncRecordCodec` deterministic record type/name mapping (including tombstone-safe encode/decode and legacy raw-UUID fallback) with focused coverage in `CloudKitSyncSchemaTests`; now added `CloudKitRecordTransport` + `CloudKitBackedSyncEngine` abstraction so sync push/pull paths can run through a real CloudKit transport adapter later, with new coverage ensuring encode-on-push, cursor forwarding, and decode/drop-invalid behavior in `CloudSyncEngineTests`; this run hardened `SyncOrchestrator` to strip echoed self-pushed records from immediate pull results (preventing local re-apply loops) while still advancing cursor from the full pulled batch, with new mixed-batch and echoed-record coverage in `SyncOrchestratorTests`; now implemented `CloudKitDatabaseRecordTransport` (CloudKit-gated) with upload + paginated pull mapped through `CloudKitSyncRecordCodec`, and added `CloudSyncEngineFactory.makeCloudKitPrivateDatabase(containerIdentifier:)` for direct private-database wiring; end-to-end multi-device replication remains pending runtime validation in Xcode/iCloud environment)
- [~] Conflict policy (integrated `SyncConflictResolver.resolveLastWriteWins` into `SyncOrchestrator` pull reconciliation so stale pulled records for identities with newer pending local pushes are dropped deterministically, while equal-timestamp ties still keep remote records; expanded `SyncOrchestratorTests` for stale-drop and tie-keep paths in addition to resolver unit tests; this run hardened pull reconciliation by normalizing duplicate pulled envelopes per identity before local apply (last-write-wins by timestamp, later record wins on ties) with new `SyncOrchestratorTests` coverage for newer-over-older and tie scenarios; runtime validation in real sync flows remains pending)

## Definition of Done (v1) follow-through
- [~] Seed data demo mode removed or behind debug flag (wired Developer Tools surface under `#if DEBUG` in Settings so demo-data controls are debug-only; release build keeps these controls hidden)
- [x] Basic privacy policy text ready (added `PrivacyPolicy.md` draft covering local-first storage, optional iCloud sync, media handling, and deletion semantics)

## PRD non-functional follow-through
- [~] Localization-ready string externalization (introduced centralized `TJStrings` copy tokens in `TravelJournal/Core/Localization/TJStrings.swift`, migrated key Home + Add Visit UI literals to shared tokens, and added `LocalizationStringsTests` for format/coverage stability; full-app migration to localized resources remains pending)

## Notes / blockers
- Per user override, Xcode project creation/tooling steps are intentionally skipped in this environment; manual Xcode import/build will be handled by the user.
- Runtime iOS/SceneKit verification and Swift test execution remain pending on a macOS/Xcode-capable runner.
- No new blockers this run.
